@page "/pipeline"
@implements IDisposable
@inject AppService AppService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>Deal Pipeline</PageTitle>

<div class="mb-3">
    <MudText Typo="Typo.h3">Deal Pipeline</MudText>
</div>

<MudDropContainer T="PipelineItem" @ref="_dropContainer" Items="@_items" ItemsSelector="@((item,column) => item.Stage == column)" ItemDropped="StageUpdated" Class="d-flex flex-wrap flex-grow-1">
    <ChildContent>
        @foreach (var stage in _stages)
        {
            <MudPaper Elevation="0" Class="pa-4 ma-4 d-flex flex-column mud-background-gray rounded-lg" Style="flex: 1 1 auto; min-width: 220px;">
                <MudToolBar DisableGutters="true">
                    <MudText Typo="Typo.subtitle1"><b>@stage</b></MudText>
                    <MudSpacer />
                    <MudText Typo="Typo.caption" Color="Color.Primary">@GetStageTotal(stage)</MudText>
                </MudToolBar>
                <MudDropZone T="PipelineItem" Identifier="@stage" Class="mud-height-full" />
                <MudButton OnClick="@(() => OnAddToStage(stage))" StartIcon="@Icons.Material.Filled.Add" FullWidth="true" Class="rounded-lg py-2">Add Deal</MudButton>
            </MudPaper>
        }
    </ChildContent>
    <ItemRenderer>
        <MudPaper Elevation="25" Class="pa-4 rounded-lg my-3">
            <div style="display: flex; flex-direction: column; align-items: start;">
                <MudText Typo="Typo.subtitle2"><b>@context.Name</b></MudText>
                <MudText Typo="Typo.body2" Color="Color.Primary" Class="mt-1">@($"${context.Value:N0}")</MudText>
                @if (!string.IsNullOrEmpty(context.CustomerName))
                {
                    <MudText Typo="Typo.caption" Class="mt-1">@context.CustomerName</MudText>
                }
                @if (context.Probability.HasValue)
                {
                    <MudProgressLinear Color="Color.Primary" Value="@((double)context.Probability)" Class="mt-2" />
                    <MudText Typo="Typo.caption">@($"{context.Probability}% probability")</MudText>
                }
                @if (context.EstimatedCloseDate.HasValue)
                {
                    <MudText Typo="Typo.caption" Class="mt-1">Close: @context.EstimatedCloseDate.Value.ToString("MMM dd, yyyy")</MudText>
                }
                <div style="display: flex; justify-content: end; width: 100%; margin-top: 8px;">
                    <MudIconButton OnClick="@(e => OnEdit(context))" Variant="Variant.Text" Color="Color.Primary" Icon="@Icons.Material.TwoTone.Edit" Size="Size.Small" />
                    <MudIconButton OnClick="@(e => OnDelete(context))" Variant="Variant.Text" Color="Color.Error" Icon="@Icons.Material.TwoTone.Delete" Size="Size.Small" />
                </div>
            </div>
        </MudPaper>
    </ItemRenderer>
</MudDropContainer>

@code {
    private MudDropContainer<PipelineItem>? _dropContainer;

    private readonly string[] _stages = { "Prospecting", "Qualification", "Proposal", "Negotiation", "Closed Won", "Closed Lost" };

    private List<PipelineItem> _items = new();

    public class PipelineItem
    {
        public long Id { get; set; }
        public string Name { get; set; } = "";
        public string Stage { get; set; } = "";
        public decimal? Value { get; set; }
        public double? Probability { get; set; }
        public string? CustomerName { get; set; }
        public DateTime? EstimatedCloseDate { get; set; }
    }

    private string GetStageTotal(string stage)
    {
        var total = _items.Where(i => i.Stage == stage).Sum(i => i.Value ?? 0);
        return $"${total:N0}";
    }

    private async Task StageUpdated(MudItemDropInfo<PipelineItem> info)
    {
        if (info.Item != null)
        {
            info.Item.Stage = info.DropzoneIdentifier;
            var opportunity = await AppService.GetOpportunityByIdAsync(info.Item.Id);
            if (opportunity != null)
            {
                opportunity.Stage = info.Item.Stage;
                try
                {
                    await AppService.UpdateOpportunityAsync(info.Item.Id, opportunity);
                }
                catch (Exception ex)
                {
                    Snackbar.Add(ex.Message, Severity.Error);
                }
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Navigation.LocationChanged += LocationChanged;
        await LoadDataAsync();
    }

    void IDisposable.Dispose()
    {
        Navigation.LocationChanged -= LocationChanged;
    }

    private async void LocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await LoadDataAsync();
        StateHasChanged();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            var result = await AppService.ListOpportunityAsync();
            if (result != null)
            {
                _items = result.Select(o => new PipelineItem
                {
                    Id = o.Id ?? 0,
                    Name = o.Name ?? $"Deal #{o.Id}",
                    Stage = o.Stage ?? "Prospecting",
                    Value = o.Value,
                    Probability = o.Probability,
                    CustomerName = o.Customer?.Name,
                    EstimatedCloseDate = o.EstimatedCloseDate
                }).ToList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }

        StateHasChanged();
        _dropContainer?.Refresh();
    }

    private async void OnAddToStage(string stage)
    {
        DialogOptions dialogOptions = new() { FullWidth = true, CloseOnEscapeKey = true };
        var result = await DialogService.Show<AddOpportunity>("Add Opportunity", dialogOptions).Result;
        if (!result.Canceled)
        {
            await LoadDataAsync();
        }
    }

    private async void OnEdit(PipelineItem item)
    {
        DialogParameters<UpdateOpportunity> dialogParams = new() { { x => x.Id, item.Id } };
        DialogOptions dialogOptions = new() { FullWidth = true, CloseOnEscapeKey = true };
        var result = await DialogService.Show<UpdateOpportunity>("Update Opportunity", dialogParams, dialogOptions).Result;
        if (!result.Canceled)
        {
            await LoadDataAsync();
        }
    }

    private async void OnDelete(PipelineItem item)
    {
        var result = await DialogService.ShowMessageBox("Warning", "Are you sure you want to delete this deal?", "Delete", "Cancel");
        if (result.GetValueOrDefault(false))
        {
            try
            {
                await AppService.DeleteOpportunityAsync(item.Id);
                await LoadDataAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
        }
    }
}
