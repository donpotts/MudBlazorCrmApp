@page "/activity"
@inject AppService AppService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject HttpClient HttpClient
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<PageTitle>Activities</PageTitle>

<div class="mb-3">
    <MudText Typo="Typo.h3">Activities</MudText>
</div>

<MudStack AlignItems="AlignItems.End" Class="mb-3">
    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.AddCircleOutline" Color="Color.Primary" OnClick="@(e => OnAdd())">Add</MudButton>
</MudStack>

<MudDataGrid T="Activity" @ref="grid" ServerData="@ServerReload" Filterable="true">
    <ToolBarContent>
         <MudText Typo="Typo.h6">Activities</MudText>
         <MudSpacer />
         <MudTextField T="string" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" Immediate="true" ValueChanged="@(value => SearchChanged(value))"></MudTextField>
         <MudButton Color="Color.Primary" OnClick="ExportAllToCSV">Export</MudButton>
    </ToolBarContent>
    <Columns>
        <PropertyColumn Property="x => x!.Id" Title="Id" />
        <PropertyColumn Property="x => x!.Type" Title="Type" />
        <PropertyColumn Property="x => x!.Subject" Title="Subject" />
        <PropertyColumn Property="x => x!.ActivityDate" Title="Date" />
        <PropertyColumn Property="x => x!.Status" Title="Status" />
        <PropertyColumn Property="x => x!.Direction" Title="Direction" />
        <TemplateColumn Title="Customer" Sortable="false" Filterable="false">
            <CellTemplate>
                @(context.Item?.Customer?.Name)
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Contact" Sortable="false" Filterable="false">
            <CellTemplate>
                @(context.Item?.Contact?.Name)
            </CellTemplate>
        </TemplateColumn>
        <PropertyColumn Property="x => x!.DurationMinutes" Title="Duration (min)" />
        <TemplateColumn Style="width: 50px;" StickyRight="true" Sortable="false" Filterable="false">
            <CellTemplate>
                <MudStack Row="true">
                    <MudIconButton Icon="@Icons.Material.Outlined.Edit" Size="@Size.Small" Title="Edit" OnClick="@(e => OnEdit(context.Item!))" />
                    <MudIconButton Icon="@Icons.Material.Outlined.Delete" Size="@Size.Small" Title="Delete" OnClick="@(e => OnDelete(context.Item!))" />
                </MudStack>
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="Activity" />
    </PagerContent>
</MudDataGrid>

<script>
    window.downloadFromBase64 = function (base64, filename) {
        var a = document.createElement("a");
        document.body.appendChild(a);
        a.style = "display: none";
        var byteCharacters = atob(base64);
        var byteNumbers = new Array(byteCharacters.length);
        for (var i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        var byteArray = new Uint8Array(byteNumbers);
        var blob = new Blob([byteArray], { type: "application/octet-stream" });
        var url = window.URL.createObjectURL(blob);
        a.href = url;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);
    };
</script>

@code {
    private MudDataGrid<Activity>? grid;
    private string? _searchString;

    private async Task<GridData<Activity>> ServerReload(GridState<Activity> state, CancellationToken cancellationToken)
    {
        var top = state.PageSize;
        var skip = state.Page * state.PageSize;
        var orderby = ODataHelpers.GetOrderBy(state.SortDefinitions);
        var filter = ODataHelpers.GetFilter(state.FilterDefinitions);

        AppService.ODataResult<Activity>? result = null;

        try
        {
            if (_searchString?.Length > 0)
            {
                filter = $"contains(tolower(Subject), '{_searchString}') or contains(tolower(Type), '{_searchString}') or contains(tolower(Status), '{_searchString}')";
            }
            result = await AppService.ListActivityODataAsync(top, skip, orderby, filter, true, "Contact,Customer,Lead,Opportunity");
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }

        return new() { TotalItems = result?.Count ?? 0, Items = result?.Value ?? Enumerable.Empty<Activity>() };
    }

    private async void OnAdd()
    {
        DialogOptions dialogOptions = new() { FullWidth = true, CloseOnEscapeKey = true };
        var dialogRef = await DialogService.ShowAsync<AddActivity>("Add Activity", dialogOptions);
        var result = await dialogRef.Result;
        if (result is { Canceled: false })
        {
            await (grid?.ReloadServerData() ?? Task.CompletedTask);
        }
    }

    private async void OnEdit(Activity record)
    {
        DialogParameters<UpdateActivity> dialogParams = new() { { x => x.Id, record.Id!.Value } };
        DialogOptions dialogOptions = new() { FullWidth = true, CloseOnEscapeKey = true };
        var dialogRef = await DialogService.ShowAsync<UpdateActivity>("Update Activity", dialogParams, dialogOptions);
        var result = await dialogRef.Result;
        if (result is { Canceled: false })
        {
            await (grid?.ReloadServerData() ?? Task.CompletedTask);
        }
    }

    private async void OnDelete(Activity record)
    {
        var result = await DialogService.ShowMessageBoxAsync("Warning", "Are you sure you want to delete this record?", "Delete", "Cancel");
        if (result.GetValueOrDefault(false))
        {
            try
            {
                await AppService.DeleteActivityAsync(record.Id!.Value);
                await (grid?.ReloadServerData() ?? Task.CompletedTask);
            }
            catch (Exception ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
        }
    }

    private void SearchChanged(string Value)
    {
        if (Value.EndsWith(".")) return;
        _searchString = Value.ToString().ToLower();
        grid?.ReloadServerData();
    }

    private async Task ExportAllToCSV()
    {
        AppService.ODataResult<Activity>? result = null;
        try
        {
            result = await AppService.ListActivityODataAsync(null, null, null, null, true, null);
            if (result?.Value != null)
            {
                var ar = result.Value.ToList().Select(x => new { x.Id, x.Type, x.Subject, x.ActivityDate, x.Status, x.Direction, x.DurationMinutes, x.CreatedBy });
                using var memoryStream = new MemoryStream();
                using (var writer = new StreamWriter(memoryStream))
                using (var csv = new CsvWriter(writer, CultureInfo.InvariantCulture))
                {
                    csv.WriteRecords(ar);
                }
                var byteArray = memoryStream.ToArray();
                var base64 = Convert.ToBase64String(byteArray);
                await JSRuntime.InvokeVoidAsync("downloadFromBase64", base64, "Activity_" + DateTime.Now.ToString("yyyyMMddHHmmss") + ".csv");
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
    }
}
