@page "/crmdashboard"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using MudBlazorCrmApp.Shared.Blazor.Components
@using MudBlazorCrmApp.Shared.Blazor.Models
@using MudBlazorCrmApp.Shared.Blazor.Authorization
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Authorization
@inject AppService AppService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject HttpClient HttpClient
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>CRM Dashboard</PageTitle>

<MudText Typo="Typo.h3">Welcome to the CRM Dashboard</MudText>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
}
else
{
    <Dashboard StorageKey="blazor-dashboard-final"
               InitialLayoutFactory="GetInitialLayout"
               CardRenderer="RenderCardContent"
               OnLayoutChanged="HandleChartsRerender" />
}

@code {
    private IJSObjectReference? _chartModule;
    private bool _isLoading = true;
    private IdentityAuthenticationStateProvider? _authProvider;

    // Data from API
    private DashboardKpis? _kpis;
    private List<SalesTrendData>? _salesTrend;
    private List<LeadSourceData>? _leadSources;
    private List<PipelineStageData>? _pipelineStages;
    private List<OpportunityDto>? _topOpportunities;
    private List<IndustryData>? _customersByIndustry;
    private SupportStats? _supportStats;

    protected override async Task OnInitializedAsync()
    {
        _authProvider = AuthenticationStateProvider as IdentityAuthenticationStateProvider;
        await LoadDashboardData();
    }

    private async Task<T?> GetAuthorizedAsync<T>(string url)
    {
        if (_authProvider == null)
        {
            throw new Exception("Not authorized");
        }

        var token = await _authProvider.GetBearerTokenAsync()
            ?? throw new Exception("Not authorized");

        HttpRequestMessage request = new(HttpMethod.Get, url);
        request.Headers.Authorization = new("Bearer", token);

        var response = await HttpClient.SendAsync(request);

        if (!response.IsSuccessStatusCode)
        {
            var message = await response.Content.ReadAsStringAsync();
            throw new Exception($"API call failed: {response.StatusCode} - {message}");
        }

        return await response.Content.ReadFromJsonAsync<T>();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            _isLoading = true;

            // Fetch all dashboard data in parallel with authorization
            var kpisTask = GetAuthorizedAsync<DashboardKpis>("api/dashboard/kpis");
            var salesTrendTask = GetAuthorizedAsync<List<SalesTrendData>>("api/dashboard/sales-trend?months=12");
            var leadSourcesTask = GetAuthorizedAsync<List<LeadSourceData>>("api/dashboard/lead-sources?months=12");
            var pipelineTask = GetAuthorizedAsync<List<PipelineStageData>>("api/dashboard/pipeline-stages");
            var opportunitiesTask = GetAuthorizedAsync<List<OpportunityDto>>("api/dashboard/top-opportunities?count=5");
            var industryTask = GetAuthorizedAsync<List<IndustryData>>("api/dashboard/customers-by-industry");
            var supportTask = GetAuthorizedAsync<SupportStats>("api/dashboard/support-stats");

            await Task.WhenAll(kpisTask, salesTrendTask, leadSourcesTask, pipelineTask, opportunitiesTask, industryTask, supportTask);

            _kpis = await kpisTask;
            _salesTrend = await salesTrendTask;
            _leadSources = await leadSourcesTask;
            _pipelineStages = await pipelineTask;
            _topOpportunities = await opportunitiesTask;
            _customersByIndustry = await industryTask;
            _supportStats = await supportTask;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard data: {ex.Message}");
            Snackbar.Add("Error loading dashboard data. Using default values.", Severity.Warning);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private List<DashboardCard> GetInitialLayout()
    {
        // Build sales chart data from real data
        var salesLabels = _salesTrend?.Select(s => s.MonthName).ToList() ?? new List<string> { "Jan", "Feb", "Mar", "Apr", "May", "Jun" };
        var salesData = _salesTrend?.Select(s => (double)(s.Total / 1000)).ToList() ?? new List<double> { 0, 0, 0, 0, 0, 0 };

        // Build lead sources chart data
        var leadLabels = _leadSources?.Select(l => l.Source ?? "Unknown").ToList() ?? new List<string>();
        var leadData = _leadSources?.Select(l => (double)l.Count).ToList() ?? new List<double>();

        // Build pipeline chart data
        var pipelineLabels = _pipelineStages?.Where(p => p.Stage != "Closed Won" && p.Stage != "Closed Lost")
            .Select(p => p.Stage ?? "Unknown").ToList() ?? new List<string>();
        var pipelineData = _pipelineStages?.Where(p => p.Stage != "Closed Won" && p.Stage != "Closed Lost")
            .Select(p => (double)(p.TotalValue / 1000)).ToList() ?? new List<double>();

        // Build customer industry chart data
        var industryLabels = _customersByIndustry?.Select(i => i.Industry ?? "Unknown").ToList() ?? new List<string>();
        var industryData = _customersByIndustry?.Select(i => (double)i.Count).ToList() ?? new List<double>();

        return new()
        {
            // Top Row - Key Performance Indicators
            new DashboardCard
            {
                Id = "sales-chart",
                CardType = "sales-chart",
                Title = "Sales Over Time",
                X = 0, Y = 0, W = 6, H = 4,
                ChartConfig = new ChartConfig
                {
                    Type = "line",
                    Labels = salesLabels,
                    Datasets = new List<ChartDataset>
                    {
                        new ChartDataset
                        {
                            Label = "Sales ($k)",
                            Data = salesData,
                            BorderColor = "#007bff",
                            BackgroundColor = "rgba(0, 123, 255, 0.1)",
                            Tension = 0.3,
                            Fill = true
                        }
                    }
                }
            },
            new DashboardCard
            {
                Id = "lead-chart",
                CardType = "lead-chart",
                Title = "Lead Sources",
                X = 6, Y = 0, W = 6, H = 4,
                ChartConfig = new ChartConfig
                {
                    Type = "doughnut",
                    Labels = leadLabels.Count > 0 ? leadLabels : new List<string> { "No Data" },
                    Datasets = new List<ChartDataset>
                    {
                        new ChartDataset
                        {
                            Label = "Lead Sources",
                            Data = leadData.Count > 0 ? leadData : new List<double> { 1 },
                            BackgroundColors = new List<string> { "#28a745", "#17a2b8", "#ffc107", "#fd7e14", "#dc3545", "#6f42c1", "#e83e8c" }
                        }
                    }
                }
            },

            // Second Row - Revenue and Pipeline Analysis
            new DashboardCard
            {
                Id = "revenue-chart",
                CardType = "revenue-chart",
                Title = "Quarterly Revenue",
                X = 0, Y = 4, W = 4, H = 4,
                ChartConfig = BuildQuarterlyRevenueChart()
            },
            new DashboardCard
            {
                Id = "pipeline-chart",
                CardType = "pipeline-chart",
                Title = "Sales Pipeline by Stage",
                X = 4, Y = 4, W = 4, H = 4,
                ChartConfig = new ChartConfig
                {
                    Type = "bar",
                    Labels = pipelineLabels.Count > 0 ? pipelineLabels : new List<string> { "No Data" },
                    Datasets = new List<ChartDataset>
                    {
                        new ChartDataset
                        {
                            Label = "Pipeline Value ($k)",
                            Data = pipelineData.Count > 0 ? pipelineData : new List<double> { 0 },
                            BackgroundColor = "rgba(54, 162, 235, 0.8)",
                            BorderColor = "rgba(54, 162, 235, 1)"
                        }
                    }
                }
            },
            new DashboardCard
            {
                Id = "industry-chart",
                CardType = "industry-chart",
                Title = "Customers by Industry",
                X = 8, Y = 4, W = 4, H = 4,
                ChartConfig = new ChartConfig
                {
                    Type = "polarArea",
                    Labels = industryLabels.Count > 0 ? industryLabels : new List<string> { "No Data" },
                    Datasets = new List<ChartDataset>
                    {
                        new ChartDataset
                        {
                            Label = "Customers",
                            Data = industryData.Count > 0 ? industryData : new List<double> { 1 },
                            BackgroundColors = new List<string> { "#ff6384", "#36a2eb", "#ffce56", "#4bc0c0", "#9966ff", "#ff9f40", "#c9cbcf", "#7bc225" }
                        }
                    }
                }
            },

            // Third Row - Support Cases Analysis
            new DashboardCard
            {
                Id = "support-status-chart",
                CardType = "support-status-chart",
                Title = "Support Cases by Status",
                X = 0, Y = 8, W = 6, H = 4,
                ChartConfig = BuildSupportStatusChart()
            },
            new DashboardCard
            {
                Id = "won-lost-chart",
                CardType = "won-lost-chart",
                Title = "Won vs Lost Deals",
                X = 6, Y = 8, W = 6, H = 4,
                ChartConfig = BuildWonLostChart()
            },

            // Fourth Row - KPIs
            new DashboardCard { Id = "kpi-leads", CardType = "leads", Title = "New Leads", X = 0, Y = 12, W = 2, H = 4 },
            new DashboardCard { Id = "kpi-revenue", CardType = "revenue", Title = "Total Revenue", X = 2, Y = 12, W = 2, H = 4 },
            new DashboardCard { Id = "kpi-conversion", CardType = "conversion", Title = "Conversion Rate", X = 4, Y = 12, W = 2, H = 4 },
            new DashboardCard { Id = "kpi-pipeline", CardType = "pipeline-value", Title = "Pipeline Value", X = 6, Y = 12, W = 2, H = 4 },
            new DashboardCard { Id = "kpi-deals", CardType = "deals-closed", Title = "Deals Closed", X = 8, Y = 12, W = 2, H = 4 },
            new DashboardCard { Id = "kpi-avg-deal", CardType = "avg-deal-size", Title = "Avg Deal Size", X = 10, Y = 12, W = 2, H = 4 },

            // Fifth Row - Management Tools
            new DashboardCard { Id = "top-opportunities", CardType = "opportunities", Title = "Top Opportunities", X = 0, Y = 16, W = 6, H = 4 },
            new DashboardCard { Id = "support-summary", CardType = "support-summary", Title = "Support Summary", X = 6, Y = 16, W = 6, H = 4 },

            // Sixth Row - Quick Tools
            new DashboardCard { Id = "key-metrics", CardType = "metrics", Title = "Key Metrics", X = 0, Y = 20, W = 6, H = 5 },
            new DashboardCard { Id = "pending-tasks", CardType = "tasks", Title = "Pending Tasks", X = 6, Y = 20, W = 6, H = 5 },
        };
    }

    private ChartConfig BuildQuarterlyRevenueChart()
    {
        if (_salesTrend == null || _salesTrend.Count == 0)
        {
            return new ChartConfig
            {
                Type = "bar",
                Labels = new List<string> { "Q1", "Q2", "Q3", "Q4" },
                Datasets = new List<ChartDataset>
                {
                    new ChartDataset { Label = "Revenue ($k)", Data = new List<double> { 0, 0, 0, 0 }, BackgroundColor = "rgba(75, 192, 192, 0.8)" }
                }
            };
        }

        // Group sales by quarter
        var quarterlyData = _salesTrend
            .GroupBy(s => (s.Month - 1) / 3 + 1)
            .OrderBy(g => g.Key)
            .Select(g => new { Quarter = $"Q{g.Key}", Total = g.Sum(s => s.Total) / 1000 })
            .ToList();

        return new ChartConfig
        {
            Type = "bar",
            Labels = quarterlyData.Select(q => q.Quarter).ToList(),
            Datasets = new List<ChartDataset>
            {
                new ChartDataset
                {
                    Label = "Revenue ($k)",
                    Data = quarterlyData.Select(q => (double)q.Total).ToList(),
                    BackgroundColor = "rgba(75, 192, 192, 0.8)",
                    BorderColor = "rgba(75, 192, 192, 1)"
                }
            }
        };
    }

    private ChartConfig BuildSupportStatusChart()
    {
        if (_supportStats?.CasesByStatus == null || _supportStats.CasesByStatus.Count == 0)
        {
            return new ChartConfig
            {
                Type = "doughnut",
                Labels = new List<string> { "No Data" },
                Datasets = new List<ChartDataset>
                {
                    new ChartDataset { Label = "Cases", Data = new List<double> { 1 }, BackgroundColors = new List<string> { "#ccc" } }
                }
            };
        }

        var statusColors = new Dictionary<string, string>
        {
            { "Open", "#dc3545" },
            { "In Progress", "#ffc107" },
            { "Waiting on Customer", "#17a2b8" },
            { "Resolved", "#28a745" },
            { "Closed", "#6c757d" }
        };

        return new ChartConfig
        {
            Type = "doughnut",
            Labels = _supportStats.CasesByStatus.Keys.ToList(),
            Datasets = new List<ChartDataset>
            {
                new ChartDataset
                {
                    Label = "Cases",
                    Data = _supportStats.CasesByStatus.Values.Select(v => (double)v).ToList(),
                    BackgroundColors = _supportStats.CasesByStatus.Keys.Select(k => statusColors.GetValueOrDefault(k, "#999")).ToList()
                }
            }
        };
    }

    private ChartConfig BuildWonLostChart()
    {
        var wonCount = _pipelineStages?.FirstOrDefault(p => p.Stage == "Closed Won")?.Count ?? 0;
        var lostCount = _pipelineStages?.FirstOrDefault(p => p.Stage == "Closed Lost")?.Count ?? 0;
        var wonValue = _pipelineStages?.FirstOrDefault(p => p.Stage == "Closed Won")?.TotalValue ?? 0;
        var lostValue = _pipelineStages?.FirstOrDefault(p => p.Stage == "Closed Lost")?.TotalValue ?? 0;

        return new ChartConfig
        {
            Type = "bar",
            Labels = new List<string> { "Won", "Lost" },
            Datasets = new List<ChartDataset>
            {
                new ChartDataset
                {
                    Label = "Deal Count",
                    Data = new List<double> { wonCount, lostCount },
                    BackgroundColors = new List<string> { "#28a745", "#dc3545" }
                }
            }
        };
    }

    private RenderFragment<DashboardCard> RenderCardContent => card => __builder =>
    {
        switch (card.CardType)
        {
            case "sales-chart":
            case "lead-chart":
            case "revenue-chart":
            case "pipeline-chart":
            case "industry-chart":
            case "support-status-chart":
            case "won-lost-chart":
                <canvas id="@(card.Id)Canvas" style="pointer-events: none;"></canvas>
                break;
            case "leads":
                <div class="kpi-card-body">
                    <div class="kpi-number">@(_kpis?.NewLeads ?? 0)</div>
                    <div class="kpi-label">This Month</div>
                    <div class="kpi-change @((_kpis?.NewLeads ?? 0) > 0 ? "positive" : "")">
                        @((_kpis?.NewLeads ?? 0) > 0 ? "Active" : "No leads")
                    </div>
                </div>
                break;
            case "revenue":
                <div class="kpi-card-body">
                    <div class="kpi-number">@FormatCurrency(_kpis?.TotalRevenue ?? 0)</div>
                    <div class="kpi-label">This Month</div>
                    <div class="kpi-change @((_kpis?.RevenueChange ?? 0) >= 0 ? "positive" : "negative")">
                        @((_kpis?.RevenueChange ?? 0) >= 0 ? "+" : "")@(Math.Round(_kpis?.RevenueChange ?? 0, 1))%
                    </div>
                </div>
                break;
            case "conversion":
                <div class="kpi-card-body">
                    <div class="kpi-number">@(Math.Round(_kpis?.ConversionRate ?? 0, 1))%</div>
                    <div class="kpi-label">Lead to Customer</div>
                    <div class="kpi-change @((_kpis?.ConversionRate ?? 0) > 20 ? "positive" : "")">
                        @((_kpis?.ConversionRate ?? 0) > 20 ? "Above target" : "Below target")
                    </div>
                </div>
                break;
            case "pipeline-value":
                <div class="kpi-card-body">
                    <div class="kpi-number">@FormatCurrency(_kpis?.PipelineValue ?? 0)</div>
                    <div class="kpi-label">Pipeline Value</div>
                    <div class="kpi-change positive">Weighted</div>
                </div>
                break;
            case "deals-closed":
                <div class="kpi-card-body">
                    <div class="kpi-number">@(_kpis?.DealsClosed ?? 0)</div>
                    <div class="kpi-label">This Month</div>
                    <div class="kpi-change @((_kpis?.DealsClosed ?? 0) > 0 ? "positive" : "")">
                        @((_kpis?.DealsClosed ?? 0) > 0 ? "Deals won" : "No deals")
                    </div>
                </div>
                break;
            case "avg-deal-size":
                <div class="kpi-card-body">
                    <div class="kpi-number">@FormatCurrency(_kpis?.AvgDealSize ?? 0)</div>
                    <div class="kpi-label">Average Deal</div>
                    <div class="kpi-change @((_kpis?.AvgDealSize ?? 0) > 50000 ? "positive" : "")">
                        @((_kpis?.AvgDealSize ?? 0) > 50000 ? "Above avg" : "Standard")
                    </div>
                </div>
                break;
            case "opportunities":
                <div class="opportunities-list">
                    @if (_topOpportunities != null && _topOpportunities.Count > 0)
                    {
                        @foreach (var opp in _topOpportunities)
                        {
                            <div class="opportunity-item">
                                <div class="opportunity-header">
                                    <span class="opportunity-name">@(opp.Name ?? "Unnamed")</span>
                                    <span class="opportunity-value">@FormatCurrency(opp.Value ?? 0)</span>
                                </div>
                                <div class="opportunity-details">
                                    <span class="opportunity-stage">@(opp.Stage ?? "Unknown")</span>
                                    <span class="opportunity-probability">@(opp.Probability ?? 0)%</span>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="opportunity-item">
                            <div class="opportunity-header">
                                <span class="opportunity-name">No open opportunities</span>
                            </div>
                        </div>
                    }
                </div>
                break;
            case "support-summary":
                <div class="metrics-card">
                    <div class="metric-row">
                        <span class="metric-label">Open Cases</span>
                        <span class="metric-value">@(_supportStats?.OpenCases ?? 0)</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">High Priority</span>
                        <span class="metric-value" style="color: #dc3545;">@(_supportStats?.HighPriorityCases ?? 0)</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Avg Resolution Time</span>
                        <span class="metric-value">@(Math.Round(_supportStats?.AvgResolutionHours ?? 0, 1)) hrs</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Active Customers</span>
                        <span class="metric-value">@(_kpis?.ActiveCustomers ?? 0)</span>
                    </div>
                </div>
                break;
            case "metrics":
                <div class="metrics-card">
                    <div class="metric-row">
                        <span class="metric-label">Active Customers</span>
                        <span class="metric-value">@(_kpis?.ActiveCustomers ?? 0)</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Open Support Cases</span>
                        <span class="metric-value">@(_kpis?.OpenSupportCases ?? 0)</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Pipeline Value</span>
                        <span class="metric-value">@FormatCurrency(_kpis?.PipelineValue ?? 0)</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Total Revenue</span>
                        <span class="metric-value">@FormatCurrency(_kpis?.TotalRevenue ?? 0)</span>
                    </div>
                </div>
                break;
            case "tasks":
                <div class="tasks-card">
                    <div class="task-item">
                        <input type="checkbox" />
                        <span>Review open opportunities (@(_topOpportunities?.Count ?? 0) pending)</span>
                    </div>
                    <div class="task-item">
                        <input type="checkbox" />
                        <span>Follow up on @(_supportStats?.OpenCases ?? 0) open support cases</span>
                    </div>
                    <div class="task-item">
                        <input type="checkbox" />
                        <span>Contact high-priority leads</span>
                    </div>
                    <div class="task-item">
                        <input type="checkbox" />
                        <span>Update CRM records</span>
                    </div>
                    <div class="task-item">
                        <input type="checkbox" />
                        <span>Review quarterly goals</span>
                    </div>
                </div>
                break;
            default:
                <div class="default-card">
                    <div class="default-card-icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <div class="default-card-content">
                        <h4>Dashboard Card</h4>
                        <p>Customize this card to display your data.</p>
                    </div>
                </div>
                break;
        }
    };

    private string FormatCurrency(decimal value)
    {
        if (value >= 1000000)
            return $"${value / 1000000:N1}M";
        if (value >= 1000)
            return $"${value / 1000:N1}K";
        return $"${value:N0}";
    }

    private async Task HandleChartsRerender()
    {
        Console.WriteLine("CRMDashboard.razor: HandleChartsRerender called");

        // Add a delay to ensure the canvas elements are in the DOM
        await Task.Delay(100);

        if (_chartModule == null)
        {
            _chartModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/MudBlazorCrmApp.Shared.Blazor/js/chart-renderer.js");
        }

        try
        {
            var layout = GetInitialLayout();

            // Render each chart with its configuration
            foreach (var card in layout.Where(c => c.ChartConfig != null))
            {
                var canvasId = $"{card.Id}Canvas";

                // Check if canvas exists before trying to render
                var canvasExists = await JSRuntime.InvokeAsync<bool>("eval", $"document.getElementById('{canvasId}') !== null");

                if (canvasExists)
                {
                    await _chartModule.InvokeVoidAsync("renderChart", canvasId, card.ChartConfig);
                    Console.WriteLine($"Rendered chart for {card.Id}");
                }
                else
                {
                    Console.WriteLine($"Canvas {canvasId} not found, will retry...");
                    // Retry after a longer delay
                    await Task.Delay(200);
                    canvasExists = await JSRuntime.InvokeAsync<bool>("eval", $"document.getElementById('{canvasId}') !== null");
                    if (canvasExists)
                    {
                        await _chartModule.InvokeVoidAsync("renderChart", canvasId, card.ChartConfig);
                        Console.WriteLine($"Rendered chart for {card.Id} on retry");
                    }
                }
            }

            Console.WriteLine("CRMDashboard.razor: All charts rendered successfully.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering charts: {ex.Message}");
        }
    }
}

@* DTO Classes for Dashboard API responses *@
@code {
    public class DashboardKpis
    {
        public int NewLeads { get; set; }
        public decimal TotalRevenue { get; set; }
        public decimal RevenueChange { get; set; }
        public decimal ConversionRate { get; set; }
        public decimal PipelineValue { get; set; }
        public int DealsClosed { get; set; }
        public decimal AvgDealSize { get; set; }
        public int ActiveCustomers { get; set; }
        public int OpenSupportCases { get; set; }
    }

    public class SalesTrendData
    {
        public int Year { get; set; }
        public int Month { get; set; }
        public decimal Total { get; set; }
        public int Count { get; set; }
        public string MonthName => new DateTime(Year, Month, 1).ToString("MMM");
    }

    public class LeadSourceData
    {
        public string? Source { get; set; }
        public int Count { get; set; }
        public decimal TotalValue { get; set; }
    }

    public class PipelineStageData
    {
        public string? Stage { get; set; }
        public int Count { get; set; }
        public decimal TotalValue { get; set; }
        public decimal WeightedValue { get; set; }
    }

    public class IndustryData
    {
        public string? Industry { get; set; }
        public int Count { get; set; }
    }

    public class SupportStats
    {
        public int OpenCases { get; set; }
        public int HighPriorityCases { get; set; }
        public double AvgResolutionHours { get; set; }
        public Dictionary<string, int> CasesByStatus { get; set; } = new();
    }

    public class OpportunityDto
    {
        public long Id { get; set; }
        public string? Name { get; set; }
        public decimal? Value { get; set; }
        public int? Probability { get; set; }
        public string? Stage { get; set; }
    }
}