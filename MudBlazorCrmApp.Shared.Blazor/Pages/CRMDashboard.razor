@page "/crmdashboard"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using MudBlazorCrmApp.Shared.Blazor.Components
@using MudBlazorCrmApp.Shared.Blazor.Models
@using MudBlazorCrmApp.Shared.Models
@inject AppService AppService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject HttpClient HttpClient
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>CRM Dashboard</PageTitle>

<MudText Typo="Typo.h3">Welcome to the CRM Dashboard</MudText>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
}
else
{
    <Dashboard StorageKey="blazor-dashboard-final"
               InitialLayoutFactory="GetInitialLayout"
               CardRenderer="RenderCardContent"
               OnLayoutChanged="HandleChartsRerender" />
}

@code {
    private IJSObjectReference? _chartModule;
    private bool _isLoading;
    private KpiSummaryDto? _kpis;
    private List<SalesOverTimeDto>? _salesData;
    private List<LeadSourceDto>? _leadSources;
    private List<PipelineStageDto>? _pipelineData;
    private List<RecentActivityDto>? _recentActivities;
    private List<TopOpportunityDto>? _topOpportunities;

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        try
        {
            var kpiTask = AppService.GetDashboardKpisAsync();
            var salesTask = AppService.GetSalesOverTimeAsync();
            var leadsTask = AppService.GetLeadSourcesAsync();
            var pipelineTask = AppService.GetPipelineByStageAsync();
            var activityTask = AppService.GetRecentActivityAsync();
            var oppsTask = AppService.GetTopOpportunitiesAsync();

            await Task.WhenAll(kpiTask, salesTask, leadsTask, pipelineTask, activityTask, oppsTask);

            _kpis = kpiTask.Result;
            _salesData = salesTask.Result;
            _leadSources = leadsTask.Result;
            _pipelineData = pipelineTask.Result;
            _recentActivities = activityTask.Result;
            _topOpportunities = oppsTask.Result;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading dashboard data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private List<DashboardCard> GetInitialLayout()
    {
        var salesLabels = _salesData?.Select(s => s.Month ?? "").ToList() ?? new List<string> { "No Data" };
        var salesValues = _salesData?.Select(s => (double)s.Total).ToList() ?? new List<double> { 0 };

        var leadLabels = _leadSources?.Select(l => l.Source ?? "Unknown").ToList() ?? new List<string> { "No Data" };
        var leadValues = _leadSources?.Select(l => (double)l.Count).ToList() ?? new List<double> { 0 };

        // Sort pipeline data in funnel order
        var stageOrder = new[] { "Prospecting", "Qualification", "Proposal", "Negotiation", "Closed Won", "Closed Lost" };
        var sortedPipeline = _pipelineData?
            .OrderBy(p => Array.IndexOf(stageOrder, p.Stage) >= 0 ? Array.IndexOf(stageOrder, p.Stage) : 99)
            .ToList() ?? new List<PipelineStageDto>();

        var pipelineLabels = sortedPipeline.Select(p => p.Stage ?? "").ToList();
        var pipelineValues = sortedPipeline.Select(p => (double)p.TotalValue).ToList();
        var pipelineCounts = sortedPipeline.Select(p => (double)p.Count).ToList();
        if (!pipelineLabels.Any()) { pipelineLabels.Add("No Data"); pipelineValues.Add(0); pipelineCounts.Add(0); }

        // Funnel data: only active pipeline stages (exclude closed)
        var funnelStages = sortedPipeline.Where(p => p.Stage != "Closed Won" && p.Stage != "Closed Lost").ToList();
        var funnelLabels = funnelStages.Select(p => p.Stage ?? "").ToList();
        var funnelCounts = funnelStages.Select(p => (double)p.Count).ToList();
        if (!funnelLabels.Any()) { funnelLabels.Add("No Data"); funnelCounts.Add(0); }

        var leadColors = new List<string> { "#28a745", "#17a2b8", "#ffc107", "#fd7e14", "#dc3545", "#6f42c1", "#007bff", "#e83e8c" };
        var pipelineColors = new List<string> { "#4CAF50", "#2196F3", "#FF9800", "#F44336", "#9C27B0", "#607D8B" };

        return new()
        {
            // Top Row - Sales and Lead Sources
            new DashboardCard
            {
                Id = "sales-chart",
                CardType = "chart",
                Title = "Sales Over Time",
                X = 0, Y = 0, W = 6, H = 4,
                ChartConfig = new ChartConfig
                {
                    Type = "line",
                    Labels = salesLabels,
                    Datasets = new List<ChartDataset>
                    {
                        new ChartDataset
                        {
                            Label = "Sales ($)",
                            Data = salesValues,
                            BorderColor = "#007bff",
                            BackgroundColor = "rgba(0, 123, 255, 0.1)",
                            Tension = 0.3,
                            Fill = true
                        }
                    }
                }
            },
            new DashboardCard
            {
                Id = "lead-chart",
                CardType = "chart",
                Title = "Lead Sources",
                X = 6, Y = 0, W = 6, H = 4,
                ChartConfig = new ChartConfig
                {
                    Type = "doughnut",
                    Labels = leadLabels,
                    Datasets = new List<ChartDataset>
                    {
                        new ChartDataset
                        {
                            Label = "Lead Sources",
                            Data = leadValues,
                            BackgroundColors = leadColors.Take(leadLabels.Count).ToList()
                        }
                    }
                }
            },

            // Second Row - Pipeline Value and Pipeline Funnel
            new DashboardCard
            {
                Id = "pipeline-chart",
                CardType = "chart",
                Title = "Pipeline Value by Stage",
                X = 0, Y = 4, W = 6, H = 4,
                ChartConfig = new ChartConfig
                {
                    Type = "bar",
                    Labels = pipelineLabels,
                    Datasets = new List<ChartDataset>
                    {
                        new ChartDataset
                        {
                            Label = "Pipeline Value ($)",
                            Data = pipelineValues,
                            BackgroundColors = pipelineColors.Take(pipelineLabels.Count).ToList()
                        }
                    }
                }
            },
            new DashboardCard
            {
                Id = "pipeline-funnel",
                CardType = "chart",
                Title = "Pipeline Funnel",
                X = 6, Y = 4, W = 6, H = 4,
                ChartConfig = new ChartConfig
                {
                    Type = "bar",
                    Labels = funnelLabels,
                    Datasets = new List<ChartDataset>
                    {
                        new ChartDataset
                        {
                            Label = "Deals in Stage",
                            Data = funnelCounts,
                            BackgroundColors = new List<string> { "#4CAF50", "#2196F3", "#FF9800", "#F44336" }.Take(funnelLabels.Count).ToList()
                        }
                    },
                    Options = new MudBlazorCrmApp.Shared.Blazor.Models.ChartOptions
                    {
                        Scales = new Dictionary<string, object>
                        {
                            { "indexAxis", "y" }
                        }
                    }
                }
            },

            // Third Row - KPIs
            new DashboardCard { Id = "kpi-leads", CardType = "leads", Title = "New Leads", X = 0, Y = 8, W = 2, H = 4 },
            new DashboardCard { Id = "kpi-revenue", CardType = "revenue", Title = "Total Revenue", X = 2, Y = 8, W = 2, H = 4 },
            new DashboardCard { Id = "kpi-conversion", CardType = "conversion", Title = "Conversion Rate", X = 4, Y = 8, W = 2, H = 4 },
            new DashboardCard { Id = "kpi-pipeline", CardType = "pipeline-value", Title = "Pipeline Value", X = 6, Y = 8, W = 2, H = 4 },
            new DashboardCard { Id = "kpi-deals", CardType = "deals-closed", Title = "Deals Closed", X = 8, Y = 8, W = 2, H = 4 },
            new DashboardCard { Id = "kpi-avg-deal", CardType = "avg-deal-size", Title = "Avg Deal Size", X = 10, Y = 8, W = 2, H = 4 },

            // Fourth Row - More KPIs
            new DashboardCard { Id = "kpi-customers", CardType = "customers", Title = "Total Customers", X = 0, Y = 12, W = 3, H = 4 },
            new DashboardCard { Id = "kpi-support", CardType = "support-cases", Title = "Open Support Cases", X = 3, Y = 12, W = 3, H = 4 },

            // Fifth Row - Activity Feed and Top Opportunities
            new DashboardCard { Id = "activity-feed", CardType = "activity", Title = "Recent Activity", X = 0, Y = 16, W = 6, H = 4 },
            new DashboardCard { Id = "top-opportunities", CardType = "opportunities", Title = "Top Opportunities", X = 6, Y = 16, W = 6, H = 4 },

            // Sixth Row - Quick Notes
            new DashboardCard { Id = "quick-notes", CardType = "notes", Title = "Quick Notes", X = 0, Y = 20, W = 6, H = 5 },
        };
    }

    private string FormatCurrency(decimal value)
    {
        if (value >= 1000000) return $"${value / 1000000:N1}M";
        if (value >= 1000) return $"${value / 1000:N1}K";
        return $"${value:N0}";
    }

    private string GetActivityIcon(string? type) => type switch
    {
        "Call" => "phone",
        "Email" => "email",
        "Meeting" => "groups",
        "Note" => "note",
        "Task" => "task_alt",
        _ => "event"
    };

    private RenderFragment<DashboardCard> RenderCardContent => card => __builder =>
    {
        switch (card.CardType)
        {
            case "chart":
                <canvas id="@(card.Id)Canvas" style="pointer-events: none;"></canvas>
                break;
            case "leads":
                <div class="kpi-card-body">
                    <div class="kpi-number">@(_kpis?.NewLeads.ToString("N0") ?? "0")</div>
                    <div class="kpi-label">Last 30 Days</div>
                </div>
                break;
            case "revenue":
                <div class="kpi-card-body">
                    <div class="kpi-number">@FormatCurrency(_kpis?.TotalRevenue ?? 0)</div>
                    <div class="kpi-label">Last 30 Days</div>
                </div>
                break;
            case "conversion":
                <div class="kpi-card-body">
                    <div class="kpi-number">@((_kpis?.ConversionRate ?? 0).ToString("N1"))%</div>
                    <div class="kpi-label">Lead to Customer</div>
                </div>
                break;
            case "pipeline-value":
                <div class="kpi-card-body">
                    <div class="kpi-number">@FormatCurrency(_kpis?.PipelineValue ?? 0)</div>
                    <div class="kpi-label">Open Pipeline</div>
                </div>
                break;
            case "deals-closed":
                <div class="kpi-card-body">
                    <div class="kpi-number">@(_kpis?.DealsClosed.ToString("N0") ?? "0")</div>
                    <div class="kpi-label">Closed Won</div>
                </div>
                break;
            case "avg-deal-size":
                <div class="kpi-card-body">
                    <div class="kpi-number">@FormatCurrency(_kpis?.AvgDealSize ?? 0)</div>
                    <div class="kpi-label">Average Deal</div>
                </div>
                break;
            case "customers":
                <div class="kpi-card-body">
                    <div class="kpi-number">@(_kpis?.TotalCustomers.ToString("N0") ?? "0")</div>
                    <div class="kpi-label">Total Customers</div>
                </div>
                break;
            case "support-cases":
                <div class="kpi-card-body">
                    <div class="kpi-number">@(_kpis?.OpenSupportCases.ToString("N0") ?? "0")</div>
                    <div class="kpi-label">Open Cases</div>
                </div>
                break;
            case "activity":
                @if (_recentActivities != null && _recentActivities.Any())
                {
                    <ul class="activity-feed">
                        @foreach (var activity in _recentActivities)
                        {
                            <li>
                                <span class="icon"><MudIcon Icon="@GetActivityIcon(activity.Type)" Size="Size.Small" /></span>
                                <strong>@activity.Subject</strong>
                                @if (!string.IsNullOrEmpty(activity.EntityName))
                                {
                                    <span> — @activity.EntityName</span>
                                }
                                <br />
                                <small>@activity.Date?.ToString("MMM dd, yyyy")</small>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <div class="default-card-content"><p>No recent activities. Log calls, emails, and meetings to see them here.</p></div>
                }
                break;
            case "opportunities":
                @if (_topOpportunities != null && _topOpportunities.Any())
                {
                    <div class="opportunities-list">
                        @foreach (var opp in _topOpportunities)
                        {
                            <div class="opportunity-item">
                                <div class="opportunity-header">
                                    <span class="opportunity-name">@opp.Name</span>
                                    <span class="opportunity-value">@FormatCurrency(opp.Value ?? 0)</span>
                                </div>
                                <div class="opportunity-details">
                                    <span class="opportunity-stage">@opp.Stage</span>
                                    @if (opp.Probability.HasValue)
                                    {
                                        <span class="opportunity-probability">@(opp.Probability.Value.ToString("N0"))%</span>
                                    }
                                </div>
                                @if (!string.IsNullOrEmpty(opp.CustomerName))
                                {
                                    <div><small>@opp.CustomerName</small></div>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="default-card-content"><p>No opportunities yet. Create opportunities to track your pipeline.</p></div>
                }
                break;
            case "notes":
                <div class="notes-card">
                    <div class="notes-header">
                        <span>Quick Notes</span>
                    </div>
                    <div class="notes-content">
                        <p>Use the Dashboard to monitor your CRM health.</p>
                        <p>• Track leads, revenue, and pipeline in real-time</p>
                        <p>• Log activities for every customer interaction</p>
                        <p>• Drag cards to customize your layout</p>
                    </div>
                </div>
                break;
            default:
                <div class="default-card">
                    <div class="default-card-content">
                        <h4>Dashboard Card</h4>
                        <p>Customize this card or drag to rearrange your dashboard.</p>
                    </div>
                </div>
                break;
        }
    };

    private async Task HandleChartsRerender()
    {
        await Task.Delay(100);

        if (_chartModule == null)
        {
            _chartModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/MudBlazorCrmApp.Shared.Blazor/js/chart-renderer.js");
        }

        try
        {
            var layout = GetInitialLayout();

            foreach (var card in layout.Where(c => c.ChartConfig != null))
            {
                var canvasId = $"{card.Id}Canvas";
                var canvasExists = await JSRuntime.InvokeAsync<bool>("eval", $"document.getElementById('{canvasId}') !== null");

                if (canvasExists)
                {
                    await _chartModule.InvokeVoidAsync("renderChart", canvasId, card.ChartConfig);
                }
                else
                {
                    await Task.Delay(200);
                    canvasExists = await JSRuntime.InvokeAsync<bool>("eval", $"document.getElementById('{canvasId}') !== null");
                    if (canvasExists)
                    {
                        await _chartModule.InvokeVoidAsync("renderChart", canvasId, card.ChartConfig);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering charts: {ex.Message}");
        }
    }
}
